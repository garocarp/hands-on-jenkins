#!/usr/bin/groovy

 pipeline {
   
	 agent any
         options {
               disableConcurrentBuilds()
                     }
      stages {
              stage('Test') {
                  steps {
                     withEnv(['PATH+EXTRA=/usr/local/bin:/usr/bin:/sbin:/bin']) 
		           {
                             sh 'env' 
                             sh 'docker --version'
                            } 
	                 }
	              }
       stage('Create') {
            steps {
                withEnv(['PATH+EXTRA=/usr/local/bin:/usr/bin:/sbin:/bin']) 
		    {
                         sh "docker ps -f name=${containerName} -q | xargs --no-run-if-empty docker stop"
	                 sh "docker ps -a -f name=${containerName} -q | xargs -r docker rm"
	                 sh "docker run -d -p ${port}:5000 --name ${containerName} hands-on-jenkins/myapp:${BUILD_NUMBER}"
                       }
                     }
                   }
               }
           }
